!***********************************************************************
! GPINPY01                                                             *
!                     Enrollment and Termination                       *
!                           of Employee                                *
!                 for ESI,PF and ESI,PF,MEDICAL and LTA.               *
!                                                                      *
!                                                                      *
!                                                                      *
!   This software and related documentation are provided under a       *
!   license agreement containing restrictions on use and               *
!   disclosure and are protected by intellectual property              *
!   laws. Except as expressly permitted in your license agreement      *
!   or allowed by law, you may not use, copy, reproduce,               *
!   translate, broadcast, modify, license, transmit, distribute,       *
!   exhibit, perform, publish or display any part, in any form or      *
!   by any means. Reverse engineering, disassembly, or                 *
!   decompilation of this software, unless required by law for         *
!   interoperability, is prohibited.                                   *
!   The information contained herein is subject to change without      *
!   notice and is not warranted to be error-free. If you find any      *
!   errors, please report them to us in writing.                       *
!                                                                      *
!   Copyright (C) 1988, 2014, Oracle and/or its affiliates.            *
!   All Rights Reserved.                                               *
!----------------------------------------------------------------------
!                                                                      *
!                                                                      *
!***********************************************************************
!                                                                      *
!          $Date:  2014/08/17:22:55:32                                 !
!       $Release:  HR92                                                !
!      $Revision:  102                                                 !
!***********************************************************************
!  Program Name : GPINPY01.SQR.                                        *
!  Description: This SQR generate the Employees Who are Enrolled to    *
!  ESI and PF,Who are Terminated from ESI,PF,Medical and LTA for   GPIN
!************************************************************************

#include 'setenv.sqc'    !Set environment

begin-setup
#include 'ptset02.sqc'
end-setup

!**********************************************************************************
begin-Report

   do Init-Report
   do Stdapi-Term

end-Report

!**********************************************************************************
begin-procedure Init-Report

   do Get-Current-DateTime
   do Init-DateTime
   do Init-Number
   do Stdapi-Init
   do get-runcntl-record
   do check
end-procedure !Init-Report

!**********************************************************************************
begin-procedure get-runcntl-record
begin-select
AA.OPRID
AA.RUN_CNTL_ID
AA.BGN_DT
AA.END_DT
AA.GPIN_GENRPT_TYPE
AA.GPIN_GENRPT_MOD
AA.GP_GENRPT_SORT_OPT
AA.CAL_PRD_ID

    let $Cal_prd_id = &AA.CAl_PRD_ID
    let $OPRID=&AA.OPRID
    let $run_cntl_id=&AA.RUN_CNTL_ID
    let $Fromdate=datetostr(&AA.BGN_DT,'DD/MM/YYYY')
    let $ThruDate=datetostr(&AA.END_DT,'DD/MM/YYYY')
    let #ReportType=&AA.GPIN_GENRPT_TYPE
    let #ReportMOde=&AA.GPIN_GENRPT_MOD
    let #SortOption=&AA.GP_GENRPT_SORT_OPT
    let $CAL_PRD_ID=&AA.CAL_PRD_ID

from PS_GPIN_PR_RC AA
where AA.OPRID = $prcs_Oprid
and   AA.RUN_CNTL_ID = $prcs_Run_Cntl_ID
end-select

DO GET-MONTH-YEAR

end-procedure !get-runcntl-record

!**********************************************************************************
begin-procedure check
Let #line1          = 4
let $DESCR_PRINT = ''
let $ReportID       = 'GPINPY01'
if (#reporttype=01)
  if (#reportmode=01)

    do ESI-ENROLL
  END-IF
END-IF
if (#reporttype=01)
  if (#reportmode=02)

    do PF-ENROLL
  END-IF
END-IF

if (#reporttype =02)
 if (#reportmode =01)
    do TERM-ESI

   end-if
 end-if

if (#reporttype =02)
 if (#reportmode =02)
    do TERM-PF

   end-if
 end-if

end-procedure !check

Begin-heading 13
#Include 'stdhdg01.sqc'
!**************************************************************************
! ESI Enrollment
!**************************************************************************


let $DESCR_PRINT1 = ltrim(rtrim($DESCR,' '),' ') || ', ' ||
                          ltrim(rtrim($ESTABLISHMENT_ADDR,' '),' ')
if (#reporttype=01)
  if (#reportmode=01)
  #Include 'stdhdg01.sqc'

        PRINT 'NEW ESI ENROLLMENT'    (2)CENTER BOLD
        PRINT 'Establishment Name :'  (6,1,21) bold
        PRINT $DESCR                  (6,23)
        PRINT 'Establishment ID:'     (6,120,20)bold
        PRINT $ESTABID                (6,+2,11)
        PRINT 'Registration No.:'      (8,1,18)bold
        PRINT $REGNO                  (8,23,11)
        PRINT 'Registration Date:'    (8,120,20)bold
        PRINT $REGDT                  (8,+2,12)
        GRAPHIC  (9,1,170)HORZ-LINE
        PRINT 'Employee ID'     (12,1,11)bold
        PRINT 'Employee '       (11,13,20)bold
        PRINT 'Name '           (12,13,20)bold
        PRINT 'Date of '        (11,35,10)bold
        PRINT 'Joining  '       (12,35,10)bold
        PRINT 'Gender'          (11,45,6)bold
        PRINT 'Father '         (11,52,20)bold
        PRINT '/Husband Name'   (12,52,20)bold
        PRINT 'Marital'         (11,73,7)bold
        PRINT 'Status'          (12,73,7)bold
        PRINT 'Home'            (11,82,20)bold
        PRINT 'Adress '         (12,82,20)bold
        PRINT 'Mailing'         (11,105,20)bold
        PRINT 'Address'         (12,105,20)bold
        PRINT 'Beneficiary'     (11,127,15)bold
        PRINT 'Beneficiary'     (11,143,20)bold
        PRINT 'Address'         (12,143,20)bold
        PRINT 'Relationship'    (11,163,12)bold
        PRINT 'to Payee'        (12,163,12)bold
        GRAPHIC  (12,1,170)HORZ-LINE

  END-IF
END-IF
!**************************************************************************
!   PF Enrollment
!**************************************************************************

if (#reporttype=01)
    if (#reportmode=02)

        alter-printer font=5 point-size=7
        PRINT 'Form - 5'   (2)CENTER BOLD
        alter-printer font=5 point-size=9
        PRINT 'Employees'' Provident Fund Organisation'(4)CENTER BOLD
        PRINT 'THE EMPLOYEES'' PROVIDENT FUND SCHEME , 1952 [Paragraph 36(2)(a)] AND THE EMPLOYEES'' PENSION SCHEME 1995 [Paragraph 20(4)]'(6)CENTER BOLD
        alter-printer font=5 point-size=9
        let $strtemp = 'Return of Employees'' qualifying for membership of the Employees'' Provident Fund,'
        let $strtemp = $strtemp || ' Employees'' Pension fund & Employees'' Deposit Linked Insurance Fund'
        let $strtemp = $strtemp || ' for the first time during the month of ' || $Month-Of-Contr
        PRINT $strtemp (8,1,)
        PRINT 'Name and address of the Factory/Estt.'(9,1,38)

         let $DESCR_PRINT1 = ltrim(rtrim($DESCR_PRINT1,' '),' ')
        PRINT $DESCR_PRINT1 (9,35) wrap 140 2
        PRINT '.' (9,33,267) Fill
        PRINT 'Code No. of the Factory/Estt.' (12,1,30)
        GRAPHIC  (12,32,30) BOX  1
        PRINT $REGNO (12,35,30)

        alter-printer font=5 point-size=8
        GRAPHIC  (+1,1,177)HORZ-LINE
        PRINT '  SI.'                                       (+1,1,5)  bold
        PRINT 'Account No.'                                 (,7,12)   bold
        PRINT 'Name of the Member'                          (,20,30)  bold
        PRINT '   Father''s Name           '                (,51,30)  bold
        PRINT 'Date of birth'                               (,82,15)  bold
        PRINT 'Sex'                                         (,98,8)   bold
        PRINT '    Date of     '                            (,107,17) bold
        PRINT 'Total period of previous service as on'      (,125,38) bold
        PRINT 'Remarks'                                     (,164,13) bold
        PRINT '  No.'                                       (+1,1,5)  bold
        PRINT '(in block capitals)'                         (,20,30)  bold
        PRINT '(or husband''s name in case '                (,51,30)  bold
        PRINT 'joining the Fund'                            (,107,17) bold
        PRINT '  the date of joining the Fund(Enclose'      (,125,38) bold
        PRINT 'of married woman)'                           (+1,51,30)bold
        PRINT '   Scheme certificate if applicable)  '      (,125,38) bold
        GRAPHIC (,1,177)HORZ-LINE

        alter-printer font=5 point-size=10
        PRINT 'Date:'                                       (52,1,10)
        PRINT 'Stamp of the Factory/Estt.'                  (52,35,27)
        PRINT 'Signature of the employer or other authorised officer of the Factory/Estt'(52,85,83)

        let $DESCR_PRINT1 = ''
    end-if
end-if
!**************************************************************************
!   ESI Termination
!**************************************************************************

if (#reporttype=02)
  if (#reportmode=01)
  #Include 'stdhdg01.sqc'
        alter-printer font=8 point-size=8
        PRINT ' List Of Employees  Terminated From ESI' (+1) center bold
        PRINT 'Establishment Name:'    (+2,1,20) bold
        PRINT $DESCR                   (,24) wrap 82 2 keep-top
        PRINT 'Establishment ID:'      (,120,20)bold
        PRINT $ESTABID                 (,+2,11)
        PRINT 'Registration No.:'      (+2,1,20)bold
        PRINT $REGNO                   (,24,11)
        PRINT 'Registration Date:'     (,50,20)bold
        PRINT $REGDT                   (,72,12)
        print 'Cancellation From:'     (+2,1,19)bold
        print $Fromdate                (,24,10)
        print 'To:'                    (,50,20)bold
        print $ThruDate                (,72,10)
        GRAPHIC (+1,1,155)HORZ-LINE
        PRINT 'Payee ID'        (+1,1,20)bold
        PRINT 'Employee  '      (,35,30)bold
        print 'Registration '   (,80,20)bold
        print 'Enrollment '     (,110,16)bold
        print 'Termination '    (,140,15)bold
        print '    '            (+1,1,11)
        print 'Name'            (,35,20)bold
        print 'Number'          (,80,20)bold
        print 'Date'            (,110,16)bold
        print 'Date'            (,140,15)bold
        GRAPHIC (,1,155)HORZ-LINE
  end-if
end-if

!**************************************************************************
!        PF Termination
!**************************************************************************

let $temp1 = ''
let $temp2 = ''

let $temp1 = '* Please state whether the member is (a)retiring according to para (69) (1) (a) or (b) of the scheme (b) leaving India for Permanent'
let $temp1 = rtrim($temp1,' ') || ' settlement abroad (c) retrenchment (d) Pt. & total disablement due to employment'
let $temp2 = 'injury (e) discharged (f) resigning or leaving service (g) taking up employment elsewhere (The name & address of the Employer should be stated)'
let $temp2 = rtrim($temp2,' ') || ' (h) death (i) attained the age of 58 years.'

if (#reporttype=02)
    if (#reportmode=02)
        alter-printer font=5 point-size=9
        PRINT 'Form - 10'   (2)CENTER BOLD
        alter-printer font=5 point-size=10
        PRINT 'Employees'' Provident Fund Organisation'(4)CENTER BOLD
        alter-printer font=5 point-size=9
        PRINT 'THE EMPLOYEES'' PROVIDENT FUNDS SCHEME, 1952 [Para 36 (2)(a) & (b)] THE EMPLOYEES'' PENSION SCHEME 1995 [Para 20 (2)]'(5)CENTER BOLD
        alter-printer font=5 point-size=9
        let $strtemp = 'Return of the members leaving service during the month of ' || $Month-Of-Contr

        PRINT $strtemp (7,1,)
        PRINT 'Name and address of the Factory/Estt.'(8,1,38)

        PRINT $DESCR_PRINT1    (8,35) wrap 140 2
        PRINT '.' (8,32,267) Fill
        PRINT 'Code No. ' (10,1,45)
        PRINT '.' (10,10,70) Fill
        PRINT $REGNO (10,11,30)

        alter-printer font=5 point-size=8
        GRAPHIC  (11,1,177)HORZ-LINE
        GRAPHIC  (,8,30)VERT-LINE
        GRAPHIC  (,32,30)VERT-LINE
        GRAPHIC  (,58,30)VERT-LINE
        GRAPHIC  (,98,30)VERT-LINE
        GRAPHIC  (,125,30)VERT-LINE
        GRAPHIC  (,160,30)VERT-LINE

        PRINT ' SI.'                              (+1,1,5) bold
        PRINT 'Account No.'                       (,12,20) bold
        PRINT 'Name of the Member'                (,33,30) bold
        PRINT 'Father''s Name or husband''s name '(,60,35) bold
        PRINT 'Date of leaving service'           (,102,25)bold
        PRINT 'Reasons for leaving service*'      (,129,30)bold
        PRINT 'Remarks'                           (,163,15)bold
        PRINT ' No.'                              (+1,1,5) bold
        PRINT '(in block letters)'                (,33,30) bold
        PRINT '(in case of married woman)'        (,60,50) bold

        GRAPHIC (13,1,177)HORZ-LINE
        print '1'(14,3)
        print '2' (,16)
        print '3' (,42)
        print '4' (,74)
        print '5' (,109)
        print '6' (,140)
        print '7' (,166)
        GRAPHIC (14,1,177)HORZ-LINE
        GRAPHIC (+27,1,177)HORZ-LINE
        alter-printer font=5 point-size=8

        PRINT  'Date :'(43,1)
        PRINT 'Signature of the employer or other authorised officer and Stamp of the Factory/Establishment.' (43,105)
        PRINT $temp1 (44,1)
        PRINT $temp2 (45,1)
        PRINT ' "Certified that the member mentioned at serial No ......................... Shri/Smt/Kum '(46,1)


        PRINT  '.' (46,63,60) FILL
        PRINT  ' was paid/not paid retrenchment compensation of Rs ' (46,90)
        PRINT '.........................................' (,130)
        PRINT 'under the Industrial Dispute Act, 1947" ' (47,3)
        PRINT 'Signature of the Employer' (+1,125)

        let $DESCR_PRINT1 = ''
    end-if
end-if
end-heading
!end-procedure

!**********************************************************************************
begin-procedure ESI-ENROLL
let $sav_estabid = ''
alter-printer font=5 point-size=6
begin-select
AE.EMPLID
BE.NAME
EE.HIRE_DT
EE.REHIRE_DT
CE.SEX
CE.MAR_STATUS
AE.ESTABID

  if $sav_estabid = ''
     let $sav_estabid =  &AE.ESTABID
     DO estab-esi
  end-if

  if $sav_estabid <> &AE.ESTABID
      new-page
      let $sav_estabid =  &AE.ESTABID
      do estab-esi
  end-if

   let $sav_estabid = &AE.ESTABID
   let $EMPLID      = &AE.EMPLID
   let $NAME        = &BE.NAME
   let $JOINDT      = datetostr(&EE.HIRE_DT,'DD/MM/YYYY')
   let $SEX         = &CE.SEX
   let $MAR         = &CE.MAR_STATUS
   LET $REHIRE      = datetostr(&EE.REHIRE_DT,'DD/MM/YYYY')
   IF $REHIRE <> ''
      LET $JOINDT = $REHIRE
   END-IF

       do dep-esi
       DO FHNAME
       DO PRINT-ESI-ENROLL
       DO UPDATE-ESI

FROM PS_GPIN_ESI_ENROLL AE,
     PS_PERSON_NAME BE,
     PS_PERS_DATA_EFFDT CE,
     PS_EMPLOYMENT EE
WHERE AE.EMPLID=BE.EMPLID
AND AE.EMPLID=CE.EMPLID
AND AE.EMPLID=EE.EMPLID
AND AE.EFF_STATUS='A'
AND AE.EFFDT=(SELECT MAX(A11.EFFDT) FROM PS_GPIN_ESI_ENROLL A11
              WHERE AE.EMPLID=A11.EMPLID
              AND A11.EFFDT between &AA.BGN_DT AND  &AA.END_DT)
AND EE.EMPLID = CE.EMPLID
AND CE.EFFDT  = (SELECT MAX(EFFDT) FROM PS_PERS_DATA_EFFDT
                 WHERE EMPLID = CE.EMPLID
                 AND   EFFDT <= &AA.END_DT)
AND BE.NAME_TYPE = 'PRI'
ORDER BY AE.ESTABID, AE.EMPLID

end-select
end-procedure !ESI-ENROLL

!**********************************************************************************
begin-procedure estab-esi
let $DESCR = ''
begin-select
B.GPIN_REG_NAME
B.ESTABID
B.GPIN_ESI_NBR
B.GPIN_ESI_DT

    LET $DESCR   = &B.GPIN_REG_NAME
    LET $ESTABID = &B.ESTABID
    LET $REGNO   = &B.GPIN_ESI_NBR
    LET $REGDT   = datetostr(&B.GPIN_ESI_DT,'DD/MM/YYYY')

FROM PS_ESTAB_TBL_GPIN B
WHERE   B.EFFDT = (SELECT MAX(EFFDT) FROM PS_ESTAB_TBL_GPIN
                  WHERE ESTABID = B.ESTABID
                  AND   EFFDT <= &AA.END_DT)
AND   B.ESTABID = $sav_estabid
end-select
end-procedure !estab-esi
!**********************************************************************************
begin-procedure dep-esi
begin-select
BD.DEPENDENT_BENEF
BN.NAME
BE.RELATIONSHIP
NN.XLATSHORTNAME

 let $dep =&BD.DEPENDENT_BENEF
 let $esi_dep_name=&BN.NAME
 LET $ESIRELATION=&NN.XLATSHORTNAME

FROM PS_DEP_BEN BD, PS_DEP_BEN_NAME BN, PS_DEP_BEN_EFF BE, PS_GPIN_ESI_ENROLL AD,PSXLATITEM NN
WHERE AD.EMPLID = $EMPLID
AND   NN.FIELDNAME = 'RELATIONSHIP'
AND   NN.FIELDVALUE = BE.RELATIONSHIP
AND   AD.EMPLID=BD.EMPLID
AND   AD.EMPLID=BN.EMPLID
AND   AD.EMPLID=BE.EMPLID
AND   BD.EMPLID=BN.EMPLID
AND   BD.EMPLID=BE.EMPLID
AND   BN.EMPLID=BE.EMPLID
AND   BD.DEPENDENT_BENEF=BN.DEPENDENT_BENEF
AND   BD.DEPENDENT_BENEF=BE.DEPENDENT_BENEF
AND   BN.DEPENDENT_BENEF=BE.DEPENDENT_BENEF
AND   AD.EFFDT = (SELECT MAX(EFFDT) FROM PS_GPIN_ESI_ENROLL
                    WHERE EMPLID = AD.EMPLID
                    AND   EFFDT <= &AA.END_DT)
AND   NN.EFFDT = (SELECT MAX(EFFDT) FROM PSXLATITEM
                        WHERE FIELDNAME = NN.FIELDNAME
                        AND   FIELDVALUE = NN.FIELDVALUE
                        AND   EFFDT <= &AA.END_DT)
AND   BN.EFFDT = (SELECT MAX(BN1.EFFDT) FROM PS_DEP_BEN_NAME BN1
                                    WHERE BN1.EMPLID = BN.EMPLID
                                    AND BN1.DEPENDENT_BENEF=BN.DEPENDENT_BENEF
                                    AND BN1.EFFDT <= &AA.END_DT)
AND   BE.EFFDT = (SELECT MAX(BE1.EFFDT) FROM PS_DEP_BEN_EFF BE1
                                    WHERE BE1.EMPLID = BE.EMPLID
                                    AND BE1.DEPENDENT_BENEF=BE.DEPENDENT_BENEF
                                    AND BE1.EFFDT <= &AA.END_DT)
AND   AD.EFFDT = (SELECT MAX(AD1.EFFDT) FROM PS_GPIN_ESI_ENROLL AD1
                                    WHERE AD1.EMPLID = AD.EMPLID
                                    AND AD1.DEPENDENT_BENEF=AD.DEPENDENT_BENEF
                                    AND AD1.EFFDT <= &AA.END_DT)
end-select
end-procedure !dep-esi
!**********************************************************************************
BEGIN-PROCEDURE FHNAME
let $FHNAME = ''
let $SPNAME = ''
BEGIN-SELECT
C.NAME
D.RELATIONSHIP
PFEEDAT2.SEX
PFEEDAT2.MAR_STATUS

    if (&PFEEDAT2.SEX = 'F' and &PFEEDAT2.MAR_STATUS = 'M' and &D.RELATIONSHIP = 'SP')
        let $SPNAME = &C.NAME
    else
        if &D.RELATIONSHIP = 'FA'
            let $FHNAME = &C.NAME
        end-if
    end-if


FROM PS_DEP_BEN B, PS_DEP_BEN_NAME C, PS_DEP_BEN_EFF D,PS_PERS_DATA_EFFDT PFEEDAT2
WHERE B.EMPLID = $EMPLID
AND B.EMPLID = C.EMPLID
AND B.EMPLID = D.EMPLID
AND C.EMPLID = D.EMPLID
AND B.DEPENDENT_BENEF = C.DEPENDENT_BENEF
AND B.DEPENDENT_BENEF = D.DEPENDENT_BENEF
AND C.DEPENDENT_BENEF = D.DEPENDENT_BENEF
AND (D.RELATIONSHIP = 'SP' OR (D.RELATIONSHIP = 'P' AND D.SEX = 'M'))
AND C.EFFDT = (SELECT MAX(C1.EFFDT) FROM PS_DEP_BEN_NAME C1
                                    WHERE C1.EMPLID =C.EMPLID
                                    AND C1.DEPENDENT_BENEF = C.DEPENDENT_BENEF
                                    AND C1.EFFDT <= &AA.END_DT)
AND D.EFFDT = (SELECT MAX(D1.EFFDT) FROM PS_DEP_BEN_EFF D1
                                    WHERE D1.EMPLID =D.EMPLID
                                    AND D1.DEPENDENT_BENEF = D.DEPENDENT_BENEF
                                    AND D1.EFFDT <= &AA.END_DT)

AND PFEEDAT2.EMPLID = B.EMPLID
AND PFEEDAT2.EFFDT  = (SELECT MAX(PFEEDAT1.EFFDT) FROM PS_PERS_DATA_EFFDT PFEEDAT1
                                          WHERE PFEEDAT1.EMPLID = PFEEDAT2.EMPLID
                                          AND PFEEDAT1.EFFDT    <= &AA.END_DT)


end-select

if ltrim(rtrim($SPNAME,' '),' ') <> ''
   let $FHNAME = $SPNAME
end-if

end-procedure !FHNAME

!**********************************************************************************
begin-procedure PRINT-ESI-ENROLL
alter-printer font=5 point-size=6

PRINT $emplid       (+1,1,11)
if LENGTH($NAME) > 22
let $NAME1 = RTRIM(LTRIM(SUBSTR($NAME,1,22),' '), ' ')
let $NAME2 = RTRIM(LTRIM(SUBSTR($NAME,23,22), ' '), ' ')
print $NAME1     (,13,)
print $NAME2     (+1,13,)
PRINT $JOINDT       (-1,35,10)
else
print $NAME              (,13,20)
PRINT $JOINDT       (,35,10)
end-if



print $sex          (,47,3)
PRINT $FHNAME       (,52,20)
PRINT $MAR          (,73,7)
Do address-esi
print $esi_home_addr  (,83,20) wrap 20 7  keep-top
print $esi_mail_addr  (,103,20) wrap 20 7 keep-top
PRINT $esi_dep_name   (,127,15)
DO ADDR-REL
print $esi_relation_addr  (,143,20) wrap 20 7 keep-top
print $ESIRELATION  (,163,12)
next-listing
end-procedure !PRINT-ESI-ENROLL
!**********************************************************************************
begin-procedure address-esi
let $ADD1 = ''
let $ADD2 = ''
let $ADD3 = ''
let $ADD4 = ''
let $ESICITY = ''
let $ESISTATE = ''
let $ESIPIN = ''
let $ESICOUNTRY = ''
let $esi_home_addr = ''
let $esi_mail_addr = ''

BEGIN-SELECT
ADDR.ADDRESS1
ADDR.ADDRESS2
ADDR.ADDRESS3
ADDR.ADDRESS4
ADDR.CITY
ADDR.STATE
ADDR.POSTAL
ADDR.COUNTRY
ADDR.ADDRESS_TYPE
 LET $ADD1=&ADDR.ADDRESS1
 LET $ADD2=&ADDR.ADDRESS2
 LET $ADD3=&ADDR.ADDRESS3
 LET $ADD4=&ADDR.ADDRESS4
 LET $ESICITY=&ADDR.CITY
 LET $ESISTATE=&ADDR.STATE
 LET $ESIPIN=&ADDR.POSTAL
 LET $ESICOUNTRY=&ADDR.COUNTRY
 LET $TYPE=&ADDR.ADDRESS_TYPE

 IF $TYPE='HOME'
    IF  ISBLANK($ADD1) <> 1
        let $esi_home_addr = $esi_home_addr || ltrim(rtrim($ADD1,' '),' ')
    END-IF

    IF  ISBLANK($ADD2) <> 1
        let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ADD2,' '),' ')
    END-IF

    IF  ISBLANK($ADD3) <> 1
        let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ADD3,' '),' ')
    END-IF

    IF  ISBLANK($ADD4) <> 1
        let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ADD4,' '),' ')
    END-IF

    IF  ISBLANK($ESICITY) <> 1
        let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ESICITY,' '),' ')
    END-IF

    IF  ISBLANK($ESISTATE) <> 1
        let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ESISTATE,' '),' ')
    END-IF

    IF  ISBLANK($ESIPIN) <> 1
          let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ESIPIN,' '),' ')
    END-IF
    IF  ISBLANK($ESICOUNTRY) <> 1
          let $esi_home_addr = $esi_home_addr || ', ' || ltrim(rtrim($ESICOUNTRY,' '),' ')
    END-IF
 END-IF

 IF $TYPE='MAIL'
    IF  ISBLANK($ADD1) <> 1
        let $esi_mail_addr = $esi_mail_addr ||  ltrim(rtrim($ADD1,' '),' ')
    END-IF
    IF  ISBLANK($ADD2) <> 1
        let $esi_mail_addr = $esi_mail_addr || ', ' || ltrim(rtrim($ADD2,' '),' ')
    END-IF

    IF  ISBLANK($ADD3) <> 1
           let $esi_mail_addr = $esi_mail_addr  ||', ' || ltrim(rtrim($ADD3,' '),' ')
    END-IF

    IF  ISBLANK($ADD4) <> 1
        let $esi_mail_addr = $esi_mail_addr || ', ' || ltrim(rtrim($ADD4,' '),' ')
    END-IF

    IF  ISBLANK($ESICITY) <> 1
        let $esi_mail_addr = $esi_mail_addr || ',' || ltrim(rtrim($ESICITY,' '),' ')
    END-IF

    IF  ISBLANK($ESISTATE) <> 1
        let $esi_mail_addr = $esi_mail_addr || ',' || ltrim(rtrim($ESISTATE,' '),' ')
    END-IF

    IF  ISBLANK($ESIPIN) <> 1
        let $esi_mail_addr = $esi_mail_addr || ',' || ltrim(rtrim($ESIPIN,' '),' ')
    END-IF
    IF  ISBLANK($ESICOUNTRY) <> 1
          let $esi_mail_addr = $esi_mail_addr || ', ' || ltrim(rtrim($ESICOUNTRY,' '),' ')
    END-IF

 END-IF

FROM PS_ADDRESSES ADDR
WHERE ADDR.EMPLID = $EMPLID
AND ADDR.EFFDT=(SELECT MAX(AX.EFFDT) FROM PS_ADDRESSES AX
                 WHERE ADDR.EMPLID=AX.EMPLID
                 AND AX.ADDRESS_TYPE = ADDR.ADDRESS_TYPE
                 AND AX.EFFDT <= &AA.END_DT)
AND ADDR.ADDRESS_TYPE IN ('HOME','MAIL')
end-select
end-procedure !address-esi

!**********************************************************************************
 !       Address Relation
!**********************************************************************************
Begin-Procedure Addr-Rel
let $READD1 = ''
let $READD2 = ''
let $READD3 = ''
let $READD4 = ''
let $RECITY = ''
let $RESTATE = ''
let $REPIN = ''
let $RECOUNTRY = ''
let $esi_relation_addr = ''

Begin-Select
READD.ADDRESS1
READD.ADDRESS2
READD.ADDRESS3
READD.ADDRESS4
READD.CITY
READD.STATE
READD.POSTAL
READD.COUNTRY
READD.SAME_ADDRESS_EMPL

  LET $READD1=&READD.ADDRESS1
  LET $READD2=&READD.ADDRESS2
  LET $READD3=&READD.ADDRESS3
  LET $READD4=&READD.ADDRESS4
  LET $RECITY=&READD.CITY
  LET $RESTATE=&READD.STATE
  LET $REPIN=&READD.POSTAL
  LET $RECOUNTRY=&READD.COUNTRY
  LET $SAMEADD=&READD.SAME_ADDRESS_EMPL

 IF $SAMEADD='Y'
     let $esi_relation_addr = $esi_home_addr
 ELSE
      IF  ISBLANK($READD1) <> 1
        let $esi_relation_addr = $esi_relation_addr || ltrim(rtrim($READD1,' '),' ')
      END-IF
     IF  ISBLANK($READD2) <> 1
          let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($ADD2,' '),' ')
     END-IF
     IF  ISBLANK($READD3) <> 1
         let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($READD3,' '),' ')
     END-IF
     IF  ISBLANK($READD4) <> 1
         let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($READD4,' '),' ')
     END-IF
     IF  ISBLANK($RECITY) <> 1
        let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($RECITY,' '),' ')
     END-IF
     IF  ISBLANK($RESTATE) <> 1
        let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($RESTATE,' '),' ')
     END-IF
     IF  ISBLANK($REPIN) <> 1
        let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($REPIN,' '),' ')
     END-IF
     IF  ISBLANK($RECOUNTRY) <> 1
        let $esi_relation_addr = $esi_relation_addr || ', ' || ltrim(rtrim($RECOUNTRY,' '),' ')
     END-IF

 END-IF
FROM  PS_DEP_BEN DEP, PS_DEP_BEN_ADDR READD
WHERE READD.EMPLID=$EMPLID
AND   READD.DEPENDENT_BENEF = $dep
AND   DEP.EMPLID = READD.EMPLID
AND   DEP.DEPENDENT_BENEF = READD.DEPENDENT_BENEF
AND   READD.EFFDT = (SELECT MAX(READD1.EFFDT) FROM PS_DEP_BEN_ADDR READD1
                                          WHERE READD1.EMPLID = READD.EMPLID
                                          AND READD1.DEPENDENT_BENEF = READD.DEPENDENT_BENEF
                                          AND READD1.EFFDT <= &AA.END_DT)
End-Select
End-Procedure !Addr-Rel
!**********************************************************************************
BEGIN-PROCEDURE UPDATE-ESI

BEGIN-SQL
UPDATE PS_GPIN_ESI_ENROLL
SET GPIN_REG_IND ='Y'
WHERE GPIN_REG_IND IN ('N','')
AND   EMPLID = &AE.EMPLID
END-sql
END-PROCEDURE !UPDATE-ESI

!**********************************************************************************
!   PF Enrollmrnt                                                                 *
!**********************************************************************************
begin-procedure PF-ENROLL
let $pf_estabid = ''
LET #CNT        = 0
LET #ROWCNT     = 0

alter-printer font=5 point-size=6
begin-select
A1.GPIN_REG_NBR
A1.EMPLID
A1.ESTABID
B1.NAME
EM1.HIRE_DT
EM1.REHIRE_DT
EP1.BIRTHDATE
C1.SEX
C1.MAR_STATUS
A1.VOLUNTARY_PCT
A1.EFFDT
A1.GPIN_ECR_LAST_NAME

     if $pf_estabid = ''
         let $pf_estabid=&A1.ESTABID
         print ' ' (+2, 1, )
         do estab-pf
     end-if

     if $pf_estabid  <> &A1.ESTABID
        LET #CNT = 0
        LET #ROWCNT = 0
        new-page
        let $pf_estabid=&A1.ESTABID
        do estab-pf
        print ' ' (+2, 1, )
     end-if

   LET $pf_estabid = &A1.ESTABID
   LET $ACCOUNT_NO = &A1.GPIN_REG_NBR
   LET $EMPLID1    = &A1.EMPLID
   LET $NAME1      = UPPER(&B1.NAME)
   LET $JOINDT3    = ''
   LET $DOB1       = datetostr(&EP1.BIRTHDATE,'DD/MM/YYYY')
   LET $SEX1       = &C1.SEX
   LET $MAR1       = &C1.MAR_STATUS
   LET $PCT        = &A1.VOLUNTARY_PCT
   LET $PFFHNAME   = &A1.GPIN_ECR_LAST_NAME
   LET #CNT = #CNT + 1

   LET $JOINDT3 = datetostr( &A1.EFFDT,'DD/MM/YYYY')

   LET #ROWCNT = #ROWCNT+1
   if #ROWCNT >= 16
     new-page
         print ' ' (+2, 1, )
     LET #ROWCNT=0
   end-if
   DO PRINT-PF-ENROLL
   DO UPDATE-PF

FROM PS_GPIN_PF_ENROLL A1,
     PS_PERSON_NAME B1,
     PS_EMPLOYMENT EM1,
     PS_PERS_DATA_EFFDT C1,
     PS_PERSON EP1
WHERE A1.EMPLID=B1.EMPLID
AND   A1.EMPLID=EP1.EMPLID
AND   A1.EMPLID=EM1.EMPLID
AND   A1.EFF_STATUS='A'
AND   A1.EMPLID=C1.EMPLID
AND   B1.NAME_TYPE = 'PRI'
AND   A1.EFFDT=(SELECT MAX(A11.EFFDT) FROM PS_GPIN_PF_ENROLL A11
              WHERE A1.EMPLID=A11.EMPLID
              AND A11.EFFDT BETWEEN &AA.BGN_DT AND &AA.END_DT)
AND   C1.EFFDT = (SELECT MAX(EFFDT) FROM PS_PERS_DATA_EFFDT
                        WHERE EMPLID = C1.EMPLID
                        AND   EFFDT <= &AA.END_DT)
ORDER BY A1.ESTABID,A1.EMPLID
end-select
end-procedure !PF-ENROLL

!**********************************************************************************
begin-procedure ESTAB-PF

let $DESCR = ''
begin-select
BP.GPIN_REG_NAME
BP.ESTABID
BP.GPIN_PF_NBR
BP.GPIN_PF_DT

    LET $DESCR   = &BP.GPIN_REG_NAME
    LET $ESTABID = &BP.ESTABID
    LET $REGNO   = &BP.GPIN_PF_NBR
    LET $REGDT   = datetostr(&BP.GPIN_PF_DT,'DD/MM/YYYY')

    DO Addr-Est

FROM PS_ESTAB_TBL_GPIN BP
WHERE BP.ESTABID = $pf_estabid
AND BP.EFFDT = (SELECT MAX(EFFDT) FROM PS_ESTAB_TBL_GPIN
                WHERE ESTABID=BP.ESTABID
                AND EFFDT < &AA.END_DT)


end-select
end-procedure !ESTAB-PF

!**********************************************************************************
!       Establishment Address
!**********************************************************************************
Begin-Procedure Addr-Est
let $ESTADD1 = ''
let $ESTADD2 = ''
let $ESTADD3 = ''
let $ESTADD4 = ''
let $ESTCITY = ''
let $ESTSTATE  = ''
let $ESTPIN    = ''
let $ESTCOUNTRY = ''
let $ESTABLISHMENT_ADDR = ''

Begin-Select
EST.ADDRESS1
EST.ADDRESS2
EST.ADDRESS3
EST.ADDRESS4
EST.CITY
EST.STATE
EST.POSTAL
EST.COUNTRY


  LET $ESTADD1=&EST.ADDRESS1
  LET $ESTADD2=&EST.ADDRESS2
  LET $ESTADD3=&EST.ADDRESS3
  LET $ESTADD4=&EST.ADDRESS4
  LET $ESTCITY=&EST.CITY
  LET $ESTSTATE=&EST.STATE
  LET $ESTPIN=&EST.POSTAL
  LET $ESTCOUNTRY=&EST.COUNTRY

      IF  ISBLANK($ESTADD1) <> 1
        let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ltrim(rtrim($ESTADD1,' '),' ')
      END-IF
     IF  ISBLANK($ESTADD2) <> 1
          let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTADD2,' '),' ')
     END-IF
     IF  ISBLANK($ESTADD3) <> 1
         let $ESTABLISHMENT_ADDR = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTADD3,' '),' ')
     END-IF
     IF  ISBLANK($ESTADD4) <> 1
         let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTADD4,' '),' ')
     END-IF
     IF  ISBLANK($ESTCITY) <> 1
        let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR || ', ' || ltrim(rtrim($ESTCITY,' '),' ')
     END-IF
     IF  ISBLANK($ESTSTATE) <> 1
        let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTSTATE,' '),' ')
     END-IF
     IF  ISBLANK($ESTPIN) <> 1
        let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTPIN,' '),' ')
     END-IF
     IF  ISBLANK($ESTCOUNTRY) <> 1
        let $ESTABLISHMENT_ADDR  = $ESTABLISHMENT_ADDR  || ', ' || ltrim(rtrim($ESTCOUNTRY,' '),' ')
     END-IF

FROM  PS_ESTAB_TBL EST
WHERE EST.ESTABID = $pf_estabid
and   EST.EFFDT = (select max (EST1.EFFDT)
                   from PS_ESTAB_TBL EST1
                   where EST1.ESTABID = EST.ESTABID
                    and EST1.EFFDT   <= &AA.END_DT)
End-Select
End-Procedure !Addr-Est

!**********************************************************************************
BEGIN-PROCEDURE DEP-PF
 alter-printer font=5 point-size=6
 let $pf_first_line = 'Y'
BEGIN-SELECT
DB.DEPENDENT_BENEF
DN.NAME
XL.XLATSHORTNAME
PFB.BENEF_PCT

        let $dep1 = &DB.DEPENDENT_BENEF
        let $dep_name = &DN.NAME

        if $pf_first_line = 'Y'
                PRINT $dep_name    (,114,11)
                let $pf_first_line = 'N'
        else
                print $dep_name    (+6,114,11)
        end-if
        do AddrP-Rel
        print $pf_relation_addr (,125,15) wrap 15 7  keep-top

        print &XL.XLATSHORTNAME  (,141,12)
        PRINT &PFB.BENEF_PCT     (,157,12) EDIT 9,99,999.00

FROM PS_DEP_BEN DB, PS_DEP_BEN_NAME DN, PS_DEP_BEN_EFF DE, PS_GPIN_PF_BENEF PFB, PSXLATITEM XL
WHERE DB.EMPLID=$EMPLID1
AND   DB.EMPLID = DN.EMPLID
AND   DB.EMPLID = DE.EMPLID
AND   DB.EMPLID = PFB.EMPLID
AND   DN.EMPLID = DE.EMPLID
AND   DN.EMPLID = PFB.EMPLID
AND   DE.EMPLID = PFB.EMPLID
AND   DB.DEPENDENT_BENEF = DN.DEPENDENT_BENEF
AND   DB.DEPENDENT_BENEF = DE.DEPENDENT_BENEF
AND   DB.DEPENDENT_BENEF = PFB.DEPENDENT_BENEF
AND   DN.DEPENDENT_BENEF = DE.DEPENDENT_BENEF
AND   DN.DEPENDENT_BENEF = PFB.DEPENDENT_BENEF
AND   DE.DEPENDENT_BENEF = PFB.DEPENDENT_BENEF
AND   XL.FIELDNAME = 'RELATIONSHIP'
AND   XL.FIELDVALUE = DE.RELATIONSHIP
AND   XL.EFFDT = (SELECT MAX(EFFDT) FROM PSXLATITEM
                        WHERE FIELDNAME = XL.FIELDNAME
                        AND   FIELDVALUE = XL.FIELDVALUE
                        AND   EFFDT <= &AA.END_DT)
AND   DN.EFFDT = (SELECT MAX(DN1.EFFDT) FROM PS_DEP_BEN_NAME DN1
                        WHERE DN1.EMPLID = DN.EMPLID
                        AND   DN1.DEPENDENT_BENEF = DN.DEPENDENT_BENEF
                        AND   DN1.EFFDT <= &AA.END_DT)
AND   DE.EFFDT = (SELECT MAX(DE1.EFFDT) FROM PS_DEP_BEN_EFF DE1
                        WHERE DE1.EMPLID = DE.EMPLID
                        AND   DE1.DEPENDENT_BENEF = DE.DEPENDENT_BENEF
                        AND   DE1.EFFDT <= &AA.END_DT)
AND   PFB.EFFDT = (SELECT MAX(PFB1.EFFDT) FROM PS_GPIN_PF_BENEF PFB1
            WHERE PFB1.EMPLID = PFB.EMPLID
                        AND   PFB1.DEPENDENT_BENEF = PFB.DEPENDENT_BENEF
                        AND   PFB1.EFFDT <= &AA.END_DT)
END-SELECT
END-PROCEDURE !DEP-PF

!**********************************************************************************
BEGIN-PROCEDURE NAMEPF
  LET $PFFHNAME = ''
  LET $PFSPNAME = ''
BEGIN-SELECT
PFDN.NAME
PFDE.RELATIONSHIP
PFEEDAT.SEX
PFEEDAT.MAR_STATUS

    if (&PFEEDAT.SEX = 'F' and &PFEEDAT.MAR_STATUS = 'M' and &PFDE.RELATIONSHIP = 'SP')
        let $PFSPNAME = &PFDN.NAME
    else
            if &PFDE.RELATIONSHIP = 'FA'
                    let $PFFHNAME = &PFDN.NAME
            end-if
    end-if


FROM  PS_DEP_BEN PFDB, PS_DEP_BEN_NAME PFDN, PS_DEP_BEN_EFF PFDE,PS_PERS_DATA_EFFDT PFEEDAT
WHERE PFDB.EMPLID=$EMPLID1
AND PFDB.EMPLID = PFDN.EMPLID
AND PFDB.EMPLID = PFDE.EMPLID
AND PFDN.EMPLID = PFDE.EMPLID
AND PFDB.DEPENDENT_BENEF = PFDN.DEPENDENT_BENEF
AND PFDB.DEPENDENT_BENEF = PFDE.DEPENDENT_BENEF
AND PFDN.DEPENDENT_BENEF = PFDE.DEPENDENT_BENEF
AND PFDE.RELATIONSHIP IN ('SP','FA')
AND PFDN.EFFDT = (SELECT MAX(PFDN1.EFFDT) FROM PS_DEP_BEN_NAME PFDN1
                                          WHERE PFDN1.EMPLID = PFDN.EMPLID
                                          AND PFDN1.DEPENDENT_BENEF = PFDN.DEPENDENT_BENEF
                                          AND PFDN1.EFFDT <= &AA.END_DT)
AND PFEEDAT.EMPLID = PFDB.EMPLID
AND PFEEDAT.EFFDT  = (SELECT MAX(PFEEDAT1.EFFDT) FROM PS_PERS_DATA_EFFDT PFEEDAT1
                                          WHERE PFEEDAT1.EMPLID = PFEEDAT.EMPLID
                                          AND PFEEDAT1.EFFDT    <= &AA.END_DT)
AND PFDE.EFFDT = (SELECT MAX(PFDE1.EFFDT) FROM PS_DEP_BEN_EFF PFDE1
                                          WHERE PFDE1.EMPLID = PFDE.EMPLID
                                          AND PFDE1.DEPENDENT_BENEF = PFDE.DEPENDENT_BENEF
                                          AND PFDE1.EFFDT <= &AA.END_DT)
AND PFEEDAT.EMPLID = PFDB.EMPLID
AND PFEEDAT.EFFDT  = (SELECT MAX(PFEEDAT1.EFFDT) FROM PS_PERS_DATA_EFFDT PFEEDAT1
                                          WHERE PFEEDAT1.EMPLID = PFEEDAT.EMPLID
                                          AND PFEEDAT1.EFFDT    <= &AA.END_DT)

END-SELECT

IF rtrim($PFSPNAME,' ') <> ''
  LET $PFFHNAME  = $PFSPNAME
END-IF

END-PROCEDURE !NAMEPF

!**********************************************************************************
begin-procedure PRINT-PF-ENROLL

!DO NAMEPF
alter-printer font=5 point-size=6
PRINT #CNT (+1,1,5) EDIT 99999
PRINT $ACCOUNT_NO (,7,12)
PRINT $NAME1      (,20,15)
PRINT $PFFHNAME   (,51,15)
PRINT $DOB1       (,82,10)
print $sex1       (,99,6)
PRINT $JOINDT3    (,107,10)
next-listing
end-procedure !PRINT-PF-ENROLL

!**********************************************************************************
BEGIN-PROCEDURE UPDATE-PF

BEGIN-SQL
UPDATE PS_GPIN_PF_ENROLL
SET GPIN_REG_IND ='Y'
WHERE GPIN_REG_IND IN ('N','')
AND   EMPLID = $emplid1
END-sql
END-PROCEDURE !UPDATE-PF


!**********************************************************************************
begin-procedure address-PF

let $addr11 = ''
let $addr21 = ''
let $addr31 = ''
let $addr41 = ''
let $pfcity = ''
let $pfstate = ''
let $pfpin = ''
let $pfcountry = ''
let $pf_home_addr = ''
let $pf_mail_addr = ''
BEGIN-SELECT
AD2.EMPLID
ADDR1.ADDRESS1
ADDR1.ADDRESS2
ADDR1.ADDRESS3
ADDR1.ADDRESS4
ADDR1.CITY
ADDR1.STATE
ADDR1.POSTAL
ADDR1.COUNTRY
ADDR1.ADDRESS_TYPE
 LET $PFADD1=&ADDR1.ADDRESS1
 LET $PFADD2=&ADDR1.ADDRESS2
 LET $PFADD3=&ADDR1.ADDRESS3
 LET $PFADD4=&ADDR1.ADDRESS4
 LET $PFCITY=&ADDR1.CITY
 LET $PFSTATE=&ADDR1.STATE
 LET $PFPIN=&ADDR1.POSTAL
 LET $PFCOUNTRY=&ADDR1.COUNTRY
 LET $TYPE1=&ADDR1.ADDRESS_TYPE

 IF $TYPE1='HOME'

    IF  ISBLANK($PFADD1) <> 1
        let $pf_home_addr = $pf_home_addr || ltrim(rtrim($PFADD1,' '),' ')
    END-IF

    IF  ISBLANK($PFADD1) <> 1
        let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFADD2,' '),' ')
    END-IF

    IF  ISBLANK($PFADD3) <> 1
        let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFADD3,' '),' ')
    END-IF

    IF  ISBLANK($PFADD4) <> 1
        let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFADD4,' '),' ')
    END-IF

    IF  ISBLANK($PFCITY) <> 1
        let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFCITY,' '),' ')
    END-IF

    IF  ISBLANK($PFSTATE) <> 1
        let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFSTATE,' '),' ')
    END-IF

    IF  ISBLANK($PFPIN) <> 1
          let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFPIN,' '),' ')
    END-IF
    IF  ISBLANK($PFCOUNTRY) <> 1
          let $pf_home_addr = $pf_home_addr || ', ' || ltrim(rtrim($PFCOUNTRY,' '),' ')
    END-IF

 END-IF

 IF $TYPE1='MAIL'
    IF  ISBLANK($PFADD1) <> 1
        let $pf_mail_addr = $pf_mail_addr || ltrim(rtrim($PFADD1,' '),' ')
    END-IF

    IF  ISBLANK($PFADD2) <> 1
        let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFADD2,' '),' ')
    END-IF

    IF  ISBLANK($PFADD3) <> 1
        let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFADD3,' '),' ')
    END-IF

    IF  ISBLANK($PFADD4) <> 1
        let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFADD4,' '),' ')
    END-IF

    IF  ISBLANK($PFCITY) <> 1
        let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFCITY,' '),' ')
    END-IF

    IF  ISBLANK($PFSTATE) <> 1
        let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFSTATE,' '),' ')
    END-IF

    IF  ISBLANK($PFPIN) <> 1
          let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFPIN,' '),' ')
    END-IF
    IF  ISBLANK($PFCOUNTRY) <> 1
          let $pf_mail_addr = $pf_mail_addr || ', ' || ltrim(rtrim($PFCOUNTRY,' '),' ')
    END-IF

  END-IF
FROM PS_GPIN_PF_ENROLL AD2,PS_ADDRESSES ADDR1
WHERE AD2.EMPLID=ADDR1.EMPLID
and ADDR1.EMPLID=$EMPLID1
AND ADDR1.EFFDT=(SELECT MAX(AX.EFFDT) FROM PS_ADDRESSES AX
                 WHERE ADDR1.EMPLID=AX.EMPLID
                 AND AX.EFFDT <= &AA.END_DT)
end-select

end-procedure !address-PF

!**********************************************************************************
!       Address Relation
!**********************************************************************************
Begin-Procedure AddrP-Rel
LET $READD11=''
LET $READD21=''
LET $READD31=''
LET $READD41=''
LET $RECITY1=''
LET $RESTATE1=''
LET $REPIN1=''
LET $RECOUNTRY1=''
let $pf_relation_addr = ''

Begin-Select
READD1.ADDRESS1
READD1.ADDRESS2
READD1.ADDRESS3
READD1.ADDRESS4
READD1.CITY
READD1.STATE
READD1.POSTAL
READD1.COUNTRY
READD1.SAME_ADDRESS_EMPL
  LET $READD11=&READD1.ADDRESS1
  LET $READD21=&READD1.ADDRESS2
  LET $READD31=&READD1.ADDRESS3
  LET $READD41=&READD1.ADDRESS4
  LET $RECITY1=&READD1.CITY
  LET $RESTATE1=&READD1.STATE
  LET $REPIN1=&READD1.POSTAL
  LET $RECOUNTRY1=&READD1.COUNTRY
  LET $SAMEADD1=&READD1.SAME_ADDRESS_EMPL

  IF $SAMEADD1='Y'
     let $pf_relation_addr = $pf_home_addr
  ELSE
  IF  ISBLANK($READD11) <> 1
        let $pf_relation_addr = $pf_relation_addr || ltrim(rtrim($READD11,' '),' ')
      END-IF
     IF  ISBLANK($READD21) <> 1
          let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($READD21,' '),' ')
     END-IF
     IF  ISBLANK($READD31) <> 1
         let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($READD31,' '),' ')
     END-IF
     IF  ISBLANK($READD41) <> 1
         let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($READD41,' '),' ')
     END-IF
     IF  ISBLANK($RECITY1) <> 1
        let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($RECITY1,' '),' ')
     END-IF
     IF  ISBLANK($RESTATE1) <> 1
        let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($RESTATE1,' '),' ')
     END-IF
     IF  ISBLANK($REPIN1) <> 1
        let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($REPIN1,' '),' ')
     END-IF
     IF  ISBLANK($RECOUNTRY1) <> 1
        let $pf_relation_addr = $pf_relation_addr || ', ' || ltrim(rtrim($RECOUNTRY1,' '),' ')
     END-IF

 END-IF
FROM PS_DEP_BEN DP, PS_DEP_BEN_ADDR READD1
WHERE READD1.EMPLID=$EMPLID1
AND  READD1.DEPENDENT_BENEF=$dep1
AND DP.EMPLID = READD1.EMPLID
AND DP.DEPENDENT_BENEF = READD1.DEPENDENT_BENEF
AND READD1.EFFDT = (SELECT MAX(EFFDT) FROM PS_DEP_BEN_ADDR
                                    WHERE EMPLID = READD1.EMPLID
                                    AND DEPENDENT_BENEF = READD1.DEPENDENT_BENEF
                                    AND EFFDT <= &AA.END_DT)
End-Select
End-Procedure !AddrP-Rel
!**********************************************************************************
!               Termination of Employees Under ESI
!**********************************************************************************
begin-procedure TERM-ESI

let $term_estabid = ''
begin-select DISTINCT
XX.EMPLID
XX.ESTABID
XX.GPIN_REG_NBR
JB.EFFDT
TESI.EFF_STATUS
XX.EFFDT
TNAME.NAME

    if &TESI.EFF_STATUS = 'A'
       let $esi_term_effdt = dateadd(&JB.EFFDT,'DAY',-1)
    else
       let $esi_term_effdt = &JB.EFFDT
    end-if

    if $term_estabid = ''
       let $term_estabid = &XX.ESTABID
       do  term-esi-estab-det
    end-if

    if  $term_estabid   <> &XX.ESTABID
         new-page
         let $term_estabid = &XX.ESTABID
         do   term-esi-estab-det

    end-if

     let $term_estabid = &XX.ESTABID
     let $templid = &XX.EMPLID
     let $tname   = &TNAME.NAME
     let $reg_no  = &XX.GPIN_REG_NBR

     let $termination_date = $esi_term_Effdt
     let $join_date =datetostr(&XX.EFFDT,'dd/mm/yyyy')
     do print-esi-termination

FROM PS_GPIN_ESI_ENROLL TESI,PS_JOB JB,
     PS_PERSON_NAME TNAME,
     PS_GPIN_ESI_ENROLL XX
WHERE TESI.EMPLID=TNAME.EMPLID
AND   TESI.EFFDT=(SELECT MAX(EFFDT) FROM PS_GPIN_ESI_ENROLL
                 WHERE EMPLID=TESI.EMPLID
                 AND   EFFDT <= &AA.END_DT)
AND TNAME.NAME_TYPE = 'PRI'
AND JB.EFFDT=(SELECT MAX(EFFDT) FROM PS_JOB WHERE EMPLID=JB.EMPLID
AND ACTION='TER' AND LAST_DATE_WORKED BETWEEN &AA.BGN_DT AND &AA.END_DT)
AND JB.EFFSEQ = (SELECT MAX(JB1.EFFSEQ) FROM PS_JOB JB1 WHERE JB1.EMPLID=JB.EMPLID
AND JB1.EFFDT = JB.EFFDT )
AND JB.EMPLID = TESI.EMPLID
AND XX.EMPLID = TESI.EMPLID
AND XX.EFFDT = TESI.EFFDT
AND XX.EFF_STATUS = 'A'
ORDER BY XX.ESTABID
end-select
end-procedure !TERM-ESI

!*******************************************************************
begin-procedure term-esi-estab-det
let $DESCR = ''
begin-select
TI.GPIN_REG_NAME
TI.ESTABID
TI.GPIN_ESI_NBR
TI.GPIN_ESI_DT

    LET $DESCR   = &TI.GPIN_REG_NAME
    LET $ESTABID = &TI.ESTABID
    LET $REGNO   = &TI.GPIN_ESI_NBR
    LET $REGDT   = datetostr(&TI.GPIN_ESI_DT,'DD/MM/YYYY')

FROM PS_ESTAB_TBL_GPIN TI
WHERE TI.EFFDT = (SELECT MAX(EFFDT) FROM PS_ESTAB_TBL_GPIN
                  WHERE ESTABID = TI.ESTABID
                  AND   EFFDT <= &AA.END_DT)
AND   TI.ESTABID = $term_estabid
end-select
end-procedure !term-esi-estab-det

!*************************************************************************
begin-procedure print-esi-termination
!*************************************************************************
!print $templid           (+1,1,20)
!print $tname             (,35,30)
print $templid           (+2,1,20)
if LENGTH($tname) > 25
let $tname1  = RTRIM(LTRIM(SUBSTR($tname,1,25),' '), ' ')
let $tname2  = RTRIM(LTRIM(SUBSTR($tname,26,25), ' '), ' ')
print $tname1      (,35,)
print $tname2      (+1,35,)
print $reg_no            (-1,80,15)
else
print $tname               (,35,30)
print $reg_no            (,80,15)
end-if
print $join_date         (,110,15)
print $termination_date  (,140,15) edit dd/mm/yyyy
end-procedure
!*************************************************************************

!*************************************************************************
!               Termination of Employees Under PF
!*************************************************************************
begin-procedure TERM-PF

let $termpf_estabid = ''
LET $pf_estabid= ''
LET #NO=0
LET #RCOUNT=0
let #estid=' '


DO Convert-To-DTU-Date(&AA.BGN_DT, $TMP_BGN_DT)
DO Convert-To-DTU-Date(&AA.END_DT, $TMP_END_DT)

DO dtu-add-days($TMP_BGN_DT, 1, $TP1_BGN_DT)
DO dtu-add-days($TMP_END_DT, 1, $TP1_END_DT)

DO Convert-From-DTU-Date($TP1_BGN_DT, $BGN_DT)
DO Convert-From-DTU-Date($TP1_END_DT, $END_DT)

begin-select DISTINCT
XX1.EMPLID
XX1.ESTABID
XX1.GPIN_REG_NBR
TPF.EFFDT
TPF.EFF_STATUS
TPFNAME.NAME
JB1.EFFDT
JB1.ACTION
JB1.ACTION_REASON
TPF.GPIN_ECR_LAST_NAME

    if &TPF.EFF_STATUS='A'
       let $pf_term_effdt = dateadd(&JB1.EFFDT,'DAY',-1)
    else
       let $pf_term_effdt =&TPF.EFFDT
    end-if

    if $termpf_estabid = ''
       let $termpf_estabid = &XX1.ESTABID
       LET $pf_estabid= $termpf_estabid
       LET #NO=0
       LET #RCOUNT=0
       let #line1 = 4
       do  term-pf-estab-det
    end-if

    if $termpf_estabid   <> &XX1.ESTABID
      LET #NO=0
      LET #RCOUNT=0
      new-page
      let $termpf_estabid = &XX1.ESTABID
      LET $pf_estabid= $termpf_estabid
      do   term-pf-estab-det
    end-if

     let $termpf_estabid       = &XX1.ESTABID
     LET $pf_estabid           = $termpf_estabid
     let $tpfname              = UPPER(&TPFNAME.NAME)
     let $pfreg_no             = &XX1.GPIN_REG_NBR
     let $EMPLID1              = &XX1.EMPLID
     let $pf_termination_date  = $pf_term_effdt
     let $PFFHNAME             = &TPF.GPIN_ECR_LAST_NAME
     let $EFFDT                = dateadd(&JB1.EFFDT,'day',-1)
     let $date_leaving_service =$EFFDT                          !datetostr($EFFDT,'dd/mm/yyyy')
     let $ACT_DESCR            = ''
     DO GET-ACTION-REASON
     let #NO= #NO+1
     LET #RCOUNT=#RCOUNT+1
     If #RCOUNT>=14
     let #line1 = 4
       new-page
       let #RCOUNT=0
     end-if
     do print-pf-termination

FROM PS_GPIN_PF_ENROLL TPF,PS_JOB JB1,
     PS_PERSON_NAME TPFNAME,
     PS_GPIN_PF_ENROLL XX1,
     PS_ACTN_REASON_TBL ACT
WHERE TPF.EMPLID=TPFNAME.EMPLID
AND   TPF.EFFDT=(SELECT MAX(EFFDT) FROM PS_GPIN_PF_ENROLL
                 WHERE EMPLID=TPF.EMPLID
                 AND   EFFDT <= &AA.END_DT)
AND TPFNAME.NAME_TYPE = 'PRI'
AND JB1.EFFDT=(SELECT MAX(EFFDT)
               FROM PS_JOB
               WHERE EMPLID=TPF.EMPLID
               AND ACTION='TER'
               AND LAST_DATE_WORKED BETWEEN &AA.BGN_DT AND &AA.END_DT)
AND XX1.EMPLID = TPF.EMPLID
AND XX1.EFFDT = TPF.EFFDT
AND XX1.EFF_STATUS = 'A'
AND JB1.EMPLID=TPF.EMPLID

ORDER BY XX1.ESTABID
end-select
end-procedure

!*******************************************************************
begin-procedure GET-ACTION-REASON
!******************************************************************
begin-select
ACT.DESCR

    LET $ACT_DESCR = RTRIM(LTRIM(&ACT.DESCR, ' '), ' ')

FROM PS_ACTN_REASON_TBL ACT
WHERE ACT.ACTION = &JB1.ACTION
AND ACT.ACTION_REASON = &JB1.ACTION_REASON
AND ACT.EFFDT = (SELECT MAX(EFFDT)
             FROM PS_ACTN_REASON_TBL ACT1
             WHERE ACT1.ACTION = ACT.ACTION
             AND ACT1.ACTION_REASON = ACT.ACTION_REASON
             AND ACT1.EFFDT <= &JB1.EFFDT)
end-select
end-procedure

!*******************************************************************
begin-procedure term-pf-estab-det
!******************************************************************

let $DESCR = ''
begin-select
TIP.GPIN_REG_NAME
TIP.ESTABID
TIP.GPIN_PF_NBR
TIP.GPIN_PF_DT

    LET $DESCR   = &TIP.GPIN_REG_NAME
    LET $ESTABID = &TIP.ESTABID
    LET $REGNO   = &TIP.GPIN_PF_NBR
    LET $REGDT   = datetostr(&TIP.GPIN_PF_DT,'DD/MM/YYYY')

    DO Addr-Est

FROM PS_ESTAB_TBL_GPIN TIP
WHERE TIP.EFFDT = (SELECT MAX(EFFDT) FROM PS_ESTAB_TBL_GPIN
                  WHERE ESTABID = TIP.ESTABID
                  AND   EFFDT <= &AA.END_DT)
AND   TIP.ESTABID = &XX1.ESTABID

end-select
end-procedure

BEGIN-PROCEDURE GET-MONTH-YEAR
move &AA.END_DT to $EndDate 'YYYY-MM-DD'
DO DTU-PARSE-DATE($EndDate, #YEAR, #MONTH, #DAY)
Evaluate  #MONTH
    when = 1
        LET $MONTH = 'JAN'
        LET #YEAR1 = #YEAR - 1
        LET #YEAR2 = #YEAR
        break
    when = 2
        LET $MONTH = 'FEB'
        LET #YEAR1 = #YEAR - 1
        LET #YEAR2 = #YEAR
        break
    when = 3
        LET $MONTH = 'MAR'
        LET #YEAR1 = #YEAR - 1
        LET #YEAR2 = #YEAR
        break
    when = 4
        LET $MONTH = 'APR'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 5
        LET $MONTH = 'MAY'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 6
        LET $MONTH = 'JUN'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 7
        LET $MONTH = 'JUL'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 8
        LET $MONTH = 'AUG'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 9
        LET $MONTH = 'SEP'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 10
        LET $MONTH = 'OCT'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 11
        LET $MONTH = 'NOV'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
    when = 12
        LET $MONTH = 'DEC'
        LET #YEAR1 = #YEAR
        LET #YEAR2 = #YEAR + 1
        break
End-Evaluate
LET $Month-Of-Contr = $MONTH || ', ' || TO_CHAR(#YEAR)
end-procedure
!*************************************************************************
begin-procedure print-pf-termination
!*************************************************************************
alter-printer font=5 point-size=6
!let $PFFHNAME =''
!DO NAMEPF
print #NO                   (#line1,1,5)EDIT 99999
print $pfreg_no             (,10,20)
if LENGTH($tpfname) > 25
let $tpfname1 = RTRIM(LTRIM(SUBSTR($tpfname,1,25),' '), ' ')
let $tpfname2 = RTRIM(LTRIM(SUBSTR($tpfname,26,25), ' '), ' ')
print $tpfname1     (,33,)
print $tpfname2      (+1,33,)
print $PFFHNAME             (-1,67,30)
else

print $tpfname              (,33,30)
print $PFFHNAME             (,67,30)
end-if

print $date_leaving_service (,104,25) EDIT 'dd/mm/yyyy'
print $ACT_DESCR            (,138,30) font = 5

let #line1 = #line1 + 2
end-procedure
!************************************************************************
#include 'setenv.sqc'
#include 'number.sqc'
#include 'reset.sqc'     !Reset Printer Procedure
#include 'curdttim.sqc'  !Get Current Date Time
#include 'datemath.sqc'  !SQR date arithmetic procedures
#include 'timemath.sqc'  !SQR time arithmetic procedures
#include 'datetime.sqc'  !Routines for date and time formatting
#include 'prcsapi.sqc'   !Update Process Request API
#include 'prcsdef.sqc'   !Update Process Request variable declare
#include 'stdapi.sqc'    !Process Scheduler API